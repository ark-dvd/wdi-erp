// ================================================
// WDI ERP - Prisma Schema
// Version: 20260114-163500
// Changes: 
//   - Added DuplicateSet model for duplicate detection
//   - Added MergeHistory model for merge tracking and undo
//   - Added User relations for duplicate management
// ================================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ AUTH & USERS ============
// RBAC v2 / INV-007: Single role per user (DOC-016 v2.0)

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  // RBAC v2 / INV-007: Single role via junction table (exactly one)
  roles         UserRole[]
  // Legacy: Keep roleId for migration, will be removed in v2
  legacyRoleId  String?   @map("roleId")
  legacyRole    Role?     @relation("LegacyUserRole", fields: [legacyRoleId], references: [id])
  employeeId    String?   @unique
  employee      Employee? @relation(fields: [employeeId], references: [id])
  isActive      Boolean   @default(true)
  lastLogin     DateTime?
  createdEvents ProjectEvent[]
  updatedProjects Project[] @relation("ProjectUpdatedBy")
  updatedOrganizations Organization[] @relation("OrganizationUpdatedBy")
  updatedContacts Contact[] @relation("ContactUpdatedBy")
  updatedContactProjects ContactProject[] @relation("ContactProjectUpdatedBy")
  importLogs    ImportLog[] @relation("UserImportLogs")
  individualReviews IndividualReview[] @relation("IndividualReviewReviewer")
  createdEquipment Equipment[] @relation("EquipmentCreatedBy")
  updatedEquipment Equipment[] @relation("EquipmentUpdatedBy")
  // Duplicate Management
  reviewedDuplicates DuplicateSet[] @relation("DuplicateSetReviewer")
  mergesMade        MergeHistory[] @relation("MergeHistoryMerger")
  mergesUndone      MergeHistory[] @relation("MergeHistoryUndoer")
  // RBAC v1: Domain assignments
  domainAssignments UserDomainAssignment[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  activityLogs  ActivityLog[] @relation("UserActivityLogs")
}

// RBAC v2 / INV-007: Single role per user (DOC-016 v2.0)
// Users must hold EXACTLY ONE role at any time. No permission unions.
model UserRole {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @unique  // INV-007: Enforces single role per user
  role      Role     @relation(fields: [roleId], references: [id])
  roleId    String
  createdAt DateTime @default(now())
  createdBy String?  // Audit: who assigned this role

  @@index([roleId])
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  displayName String
  description String?
  // Role hierarchy level for UI ordering (lower = more privileged)
  level       Int              @default(100)
  permissions RolePermission[]
  userRoles   UserRole[]
  // Legacy relation - will be removed
  legacyUsers User[]           @relation("LegacyUserRole")
  createdAt   DateTime         @default(now())
}

model Permission {
  id          String           @id @default(cuid())
  module      String
  action      String
  // RBAC v2: Scope dimension per DOC-013 §5.1
  scope       String           @default("ALL") // ALL, DOMAIN, ASSIGNED, OWN, SELF, MAIN_PAGE, CONTACTS
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())

  @@unique([module, action, scope])
}

model RolePermission {
  id           String     @id @default(cuid())
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId       String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  permissionId String
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
}

model AllowedDomain {
  id        String   @id @default(cuid())
  domain    String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

// RBAC v1: Functional domain definitions (DOC-013 §5.1)
model Domain {
  id          String   @id @default(cuid())
  name        String   @unique  // e.g., 'construction', 'infrastructure'
  displayName String             // Hebrew name
  description String?
  isActive    Boolean  @default(true)
  users       UserDomainAssignment[]
  projects    Project[] @relation("ProjectDomain")
  createdAt   DateTime @default(now())
}

// RBAC v1: User-to-domain mapping for DOMAIN scope
model UserDomainAssignment {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  domain    Domain   @relation(fields: [domainId], references: [id])
  domainId  String
  createdAt DateTime @default(now())
  createdBy String?  // Audit

  @@unique([userId, domainId])
  @@index([userId])
  @@index([domainId])
}


// ============ HR MODULE ============

model Employee {
  id                    String    @id @default(cuid())
  firstName             String
  lastName              String
  idNumber              String    @unique
  birthDate             DateTime?
  phone                 String?
  email                 String?
  personalEmail         String?
  address               String?
  spouseFirstName       String?
  spouseLastName        String?
  spouseIdNumber        String?
  spouseBirthDate       DateTime?
  spousePhone           String?
  spouseEmail           String?
  marriageDate          DateTime?
  children              String?   @db.Text
  education             String?   @db.Text
  certifications        String?   @db.Text
  role                  String
  department            String?
  employmentType        String    @default("אורגני")
  employeeCategory      String?
  employmentPercent     Float?
  startDate             DateTime?
  endDate               DateTime?
  grossSalary           Float?
  status                String    @default("פעיל")
  securityClearance     Int?
  linkedinUrl           String?
  photoUrl              String?
  idCardFileUrl         String?
  idCardSpouseFileUrl   String?
  driversLicenseFileUrl String?
  contractFileUrl       String?
  user                  User?
  ledProjects           Project[] @relation("ProjectLead")
  managedProjects       ProjectManager[]
  coordinatedProjects   ProjectCoordinator[]
  assignedEquipment     Equipment[]
  equipmentAssignments  EquipmentAssignment[] @relation("EquipmentAssignments")
  currentVehicle        Vehicle?              @relation("CurrentVehicle")
  vehicleAssignments    VehicleAssignment[]   @relation("VehicleAssignments")
  vehicleAccidents      VehicleAccident[]     @relation("EmployeeAccidents")
  vehicleFuelLogs       VehicleFuelLog[]      @relation("EmployeeFuelLogs")
  vehicleTollRoads      VehicleTollRoad[]     @relation("EmployeeTollRoads")
  vehicleParkings       VehicleParking[]      @relation("EmployeeParkings")
  vehicleTickets        VehicleTicket[]       @relation("EmployeeTickets")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// ============ PROJECTS MODULE ============

model Project {
  id              String    @id @default(cuid())
  projectNumber   String    @unique
  name            String
  address         String?
  category        String?
  client          String?
  phase           String?
  state           String    @default("פעיל")
  area            Float?
  estimatedCost   Float?
  startDate       DateTime?
  endDate         DateTime?
  description     String?   @db.Text
  services        String[]  @default([])
  buildingTypes   String[]  @default([])
  deliveryMethods String[]  @default([])
  projectType     String    @default("single")
  level           String    @default("project")
  parentId        String?
  parent          Project?  @relation("ProjectHierarchy", fields: [parentId], references: [id])
  children        Project[] @relation("ProjectHierarchy")
  leadId          String?
  lead            Employee? @relation("ProjectLead", fields: [leadId], references: [id])
  managers        ProjectManager[]
  coordinators    ProjectCoordinator[]
  events          ProjectEvent[]
  contacts        ProjectContact[]
  contactProjects ContactProject[]
  individualReviews IndividualReview[]
  // RBAC v1: Domain assignment for DOMAIN scope
  domainId        String?
  domain          Domain?   @relation("ProjectDomain", fields: [domainId], references: [id])
  updatedById     String?
  updatedBy       User?     @relation("ProjectUpdatedBy", fields: [updatedById], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model ProjectCoordinator {
  id         String   @id @default(cuid())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId  String
  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId String
  createdAt  DateTime @default(now())
  @@unique([projectId, employeeId])
}

model ProjectContact {
  id        String   @id @default(cuid())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  name      String
  role      String?
  phone     String?
  email     String?
  company   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============ CONTACTS MODULE ============

model Organization {
  id            String    @id @default(cuid())
  name          String
  type          String?
  phone         String?
  email         String?
  website       String?
  address       String?
  businessId    String?
  logoUrl       String?
  isVendor      Boolean   @default(false)
  contactTypes  String[]  @default([])
  disciplines   String[]  @default([])
  otherText     String?   // Free text for "אחר" contact type
  averageRating Float?
  reviewCount   Int       @default(0)
  notes         String?   @db.Text
  contacts      Contact[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  updatedById   String?
  updatedBy     User?     @relation("OrganizationUpdatedBy", fields: [updatedById], references: [id])
}

model Contact {
  id              String    @id @default(cuid())
  firstName       String
  lastName        String
  nickname        String?
  birthDate       DateTime?
  isVendor        Boolean   @default(false)
  phone           String
  phoneAlt        String?
  email           String?
  emailAlt        String?
  linkedinUrl     String?
  photoUrl        String?
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id])
  role            String?
  department      String?
  contactTypes    String[]  @default([])
  disciplines     String[]  @default([])
  otherText       String?   // Free text for "אחר" contact type
  averageRating   Float?
  reviewCount     Int       @default(0)
  specialization  String?
  status          String    @default("פעיל")
  notes           String?   @db.Text
  vendorId        String?
  vendor          Vendor?   @relation(fields: [vendorId], references: [id])
  projects        ContactProject[]
  individualReviews IndividualReview[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  updatedById     String?
  updatedBy       User?     @relation("ContactUpdatedBy", fields: [updatedById], references: [id])
}

model ContactProject {
  id              String    @id @default(cuid())
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  contactId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId       String
  roleInProject   String?
  startDate       DateTime?
  endDate         DateTime?
  status          String    @default("פעיל")
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  updatedById     String?
  updatedBy       User?     @relation("ContactProjectUpdatedBy", fields: [updatedById], references: [id])
  @@unique([contactId, projectId])
}

// ============ EVENTS MODULE ============

model ProjectEvent {
  id          String      @id @default(cuid())
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId   String
  eventType   String
  eventDate   DateTime
  description String      @db.Text
  createdById String?
  createdBy   User?       @relation(fields: [createdById], references: [id])
  files       EventFile[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model EventFile {
  // Version: 20260111-190000 - Added text extraction fields
  id        String       @id @default(cuid())
  event     ProjectEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId   String
  fileUrl   String
  fileName  String
  fileType  String
  fileSize        Int?
  extractedText   String?      @db.Text
  textExtractedAt DateTime?
  createdAt DateTime     @default(now())
}

// ============ EQUIPMENT MODULE ============

// ============ EQUIPMENT MODULE - Updated 12.01.2026 ============

enum EquipmentType {
  LAPTOP            // מחשב נייד
  CHARGER           // מטען למחשב
  DOCKING_STATION   // תחנת עגינה
  MONITOR           // מסך
  MOUSE             // עכבר
  KEYBOARD          // מקלדת
  MONITOR_ARM       // זרוע למסך
  MEETING_ROOM_TV   // מסך/טלוויזיה חדר ישיבות
  PRINTER           // מדפסת
  SCANNER           // סורק
  OTHER             // אחר
}

enum EquipmentStatus {
  ACTIVE            // פעיל
  INACTIVE          // מושבת
  IN_REPAIR         // בתיקון
  SOLD              // נמכר
  LOST              // אבד
}

model Equipment {
  id                  String            @id @default(cuid())
  
  // Basic info
  type                EquipmentType
  typeOther           String?           // אם סוג = אחר
  manufacturer        String            // יצרן
  model               String            // דגם
  serialNumber        String?           @unique // מספר סריאלי
  yearOfManufacture   Int?              // שנת ייצור
  
  // Purchase info
  supplier            String?           // ספק
  purchaseDate        DateTime?         // תאריך רכישה
  warrantyExpiry      DateTime?         // תאריך תפוגת אחריות
  invoiceUrl          String?           // קישור לחשבונית
  
  // Location & Status
  location            String?           // משרד / בית העובד / חדר ישיבות א'
  status              EquipmentStatus   @default(ACTIVE)
  isOfficeEquipment   Boolean           @default(false) // true = ציוד משרדי
  
  // Current assignment
  currentAssigneeId   String?
  currentAssignee     Employee?         @relation(fields: [currentAssigneeId], references: [id])
  
  // Screen size (for monitors, laptops, meeting room TVs)
  screenSizeInch      Float?            // גודל מסך באינצ'ים
  
  // Laptop-specific fields
  processor           String?           // מעבד
  ramGB               Int?              // זיכרון
  storageGB           Int?              // אחסון
  hasTouchscreen      Boolean?          // מסך מגע
  operatingSystem     String?           // מערכת הפעלה
  
  // Notes
  notes               String?           @db.Text
  
  // Assignment history
  assignments         EquipmentAssignment[]
  
  // Metadata
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  createdById         String?
  createdBy           User?             @relation("EquipmentCreatedBy", fields: [createdById], references: [id])
  updatedById         String?
  updatedBy           User?             @relation("EquipmentUpdatedBy", fields: [updatedById], references: [id])
  
  @@map("equipment")
}

model EquipmentAssignment {
  id            String      @id @default(cuid())
  
  equipment     Equipment   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  equipmentId   String
  employee      Employee    @relation("EquipmentAssignments", fields: [employeeId], references: [id])
  employeeId    String
  
  startDate     DateTime    @default(now())
  endDate       DateTime?
  notes         String?
  
  createdAt     DateTime    @default(now())
  
  @@index([equipmentId])
  @@index([employeeId])
  @@map("equipment_assignments")
}

// ============ VEHICLES MODULE ============

enum VehicleStatus {
  ACTIVE        // פעיל
  IN_SERVICE    // בטיפול
  RETURNED      // הוחזר
  SOLD          // נמכר
}

enum VehicleContractType {
  RENTAL    // השכרה - קצר טווח
  LEASING   // ליסינג - ארוך טווח
}

enum AccidentStatus {
  OPEN          // פתוח
  IN_PROGRESS   // בטיפול
  CLOSED        // סגור
}

enum TicketStatus {
  PENDING       // ממתין לתשלום
  PAID          // שולם
  APPEALED      // בערעור
  CANCELLED     // בוטל
}

enum VehicleDocumentType {
  LICENSE       // רישיון רכב
  INSURANCE     // תעודת ביטוח
  WINTER_CHECK  // בדיקת חורף שנתית
}

enum VehiclePhotoType {
  FRONT         // חזית
  REAR          // אחור
  RIGHT_SIDE    // צד ימין
  LEFT_SIDE     // צד שמאל
  INTERIOR      // פנים
  OTHER         // אחר
}

enum VehiclePhotoEvent {
  HANDOVER_IN   // קבלה (עובד חדש מקבל)
  HANDOVER_OUT  // מסירה (עובד קודם מוסר)
  GENERAL       // כללי
  ACCIDENT      // תאונה
  SERVICE       // טיפול
}

model Vehicle {
  id                 String              @id @default(cuid())
  licensePlate       String              @unique
  manufacturer       String
  model              String
  year               Int?
  color              String?
  
  contractType       VehicleContractType?
  leasingCompany     String?
  contractStartDate  DateTime?
  contractEndDate    DateTime?
  monthlyPayment     Float?
  
  currentKm          Int?
  lastServiceDate    DateTime?
  lastServiceKm      Int?
  nextServiceDate    DateTime?
  nextServiceKm      Int?
  
  status             VehicleStatus       @default(ACTIVE)
  notes              String?             @db.Text
  
  currentDriverId    String?             @unique
  currentDriver      Employee?           @relation("CurrentVehicle", fields: [currentDriverId], references: [id])
  assignments        VehicleAssignment[]
  services           VehicleService[]
  accidents          VehicleAccident[]   @relation("VehicleAccidents")
  fuelLogs           VehicleFuelLog[]
  tollRoads          VehicleTollRoad[]
  parkings           VehicleParking[]
  tickets            VehicleTicket[]
  documents          VehicleDocument[]
  photos             VehiclePhoto[]
  
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}

model VehicleAssignment {
  id          String         @id @default(cuid())
  vehicle     Vehicle        @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId   String
  employee    Employee       @relation("VehicleAssignments", fields: [employeeId], references: [id])
  employeeId  String
  startDate   DateTime       @default(now())
  endDate     DateTime?
  startKm     Int?
  endKm       Int?
  notes       String?
  photos      VehiclePhoto[]
  createdAt   DateTime       @default(now())
  
  @@index([vehicleId])
  @@index([employeeId])
}

model VehicleService {
  id            String   @id @default(cuid())
  vehicle       Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId     String
  serviceDate   DateTime
  serviceType   String
  mileage       Int?
  cost          Float?
  garage        String?
  description   String?  @db.Text
  invoiceUrl    String?
  createdAt     DateTime @default(now())
  
  @@index([vehicleId])
}

model VehicleAccident {
  id             String         @id @default(cuid())
  vehicle        Vehicle        @relation("VehicleAccidents", fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId      String
  date           DateTime
  employee       Employee?      @relation("EmployeeAccidents", fields: [employeeId], references: [id])
  employeeId     String?
  location       String?
  description    String?        @db.Text
  thirdParty     String?
  policeReport   Boolean        @default(false)
  policeFileNum  String?
  cost           Float?
  insuranceClaim Boolean        @default(false)
  insuranceNum   String?
  status         String         @default("פתוח")
  fileUrl        String?
  notes          String?        @db.Text
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  @@index([vehicleId])
  @@index([employeeId])
}

model VehicleFuelLog {
  id            String    @id @default(cuid())
  vehicle       Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId     String
  date          DateTime
  employee      Employee? @relation("EmployeeFuelLogs", fields: [employeeId], references: [id])
  employeeId    String?
  liters        Float
  pricePerLiter Float?
  totalCost     Float
  mileage       Int?
  station       String?
  fuelType      String?
  fullTank      Boolean   @default(true)
  receiptUrl    String?
  createdAt     DateTime  @default(now())
  
  @@index([vehicleId])
  @@index([employeeId])
}

model VehicleTollRoad {
  id          String    @id @default(cuid())
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId   String
  date        DateTime
  employee    Employee? @relation("EmployeeTollRoads", fields: [employeeId], references: [id])
  employeeId  String?
  road        String
  entryPoint  String?
  exitPoint   String?
  cost        Float
  invoiceNum  String?
  notes       String?
  createdAt   DateTime  @default(now())
  
  @@index([vehicleId])
  @@index([employeeId])
  @@index([date])
}

model VehicleParking {
  id          String    @id @default(cuid())
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId   String
  date        DateTime
  employee    Employee? @relation("EmployeeParkings", fields: [employeeId], references: [id])
  employeeId  String?
  location    String
  parkingLot  String?
  duration    Int?
  cost        Float
  receiptUrl  String?
  notes       String?
  createdAt   DateTime  @default(now())
  
  @@index([vehicleId])
  @@index([employeeId])
  @@index([date])
}

model VehicleTicket {
  id            String       @id @default(cuid())
  vehicle       Vehicle      @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId     String
  date          DateTime
  employee      Employee?    @relation("EmployeeTickets", fields: [employeeId], references: [id])
  employeeId    String?
  ticketType    String
  ticketNumber  String?
  location      String?
  description   String?      @db.Text
  fineAmount    Float
  points        Int?
  dueDate       DateTime?
  status        TicketStatus @default(PENDING)
  paidDate      DateTime?
  paidAmount    Float?
  appealDate    DateTime?
  appealResult  String?
  fileUrl       String?
  notes         String?      @db.Text
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@index([vehicleId])
  @@index([employeeId])
  @@index([date])
  @@index([status])
}

model VehicleDocument {
  id           String              @id @default(cuid())
  vehicle      Vehicle             @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId    String
  type         VehicleDocumentType
  fileUrl      String
  fileName     String
  expiryDate   DateTime?           // תאריך תוקף
  issueDate    DateTime?           // תאריך הנפקה
  notes        String?
  createdAt    DateTime            @default(now())
  createdBy    String?             // מי העלה
  
  @@index([vehicleId])
  @@index([type])
  @@index([expiryDate])
}

model VehiclePhoto {
  id            String             @id @default(cuid())
  vehicle       Vehicle            @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  vehicleId     String
  assignment    VehicleAssignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  assignmentId  String?            // שיוך (לתמונות קבלה/מסירה)
  photoType     VehiclePhotoType   // סוג תמונה: חזית, אחור, צד
  eventType     VehiclePhotoEvent  // סוג אירוע: קבלה, מסירה, כללי
  fileUrl       String
  fileName      String
  takenAt       DateTime           @default(now()) // מתי צולם
  notes         String?
  createdAt     DateTime           @default(now())
  createdBy     String?            // מי העלה
  
  @@index([vehicleId])
  @@index([assignmentId])
  @@index([eventType])
}

// ============ VENDORS MODULE (Legacy) ============

model Vendor {
  id             String          @id @default(cuid())
  name           String
  discipline     String
  phone          String?
  email          String?
  address        String?
  website        String?
  notes          String?         @db.Text
  vendorContacts VendorContact[]
  ratings        VendorRating[]
  contacts       Contact[]
  avgRating      Float?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
}

model VendorContact {
  id        String   @id @default(cuid())
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId  String
  name      String
  role      String?
  phone     String?
  email     String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VendorRating {
  id             String   @id @default(cuid())
  vendor         Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId       String
  projectId      String?
  ratedById      String?
  planningQuality Int?
  timeliness     Int?
  communication  Int?
  pricing        Int?
  recommendation Int?
  comments       String?  @db.Text
  createdAt      DateTime @default(now())
}

model ProjectManager {
  id         String   @id @default(cuid())
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId  String
  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId String
  createdAt  DateTime @default(now())
  @@unique([projectId, employeeId])
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation("UserActivityLogs", fields: [userId], references: [id])
  userEmail   String
  userRole    String?
  action      String
  category    String
  module      String?
  path        String?
  targetType  String?
  targetId    String?
  targetName  String?
  details     Json?
  ip          String?
  userAgent   String?
  duration    Int?
  success     Boolean  @default(true)
  createdAt   DateTime @default(now())
  @@index([userId])
  @@index([action])
  @@index([module])
  @@index([category])
  @@index([createdAt])
  @@index([userEmail])
}

// ============ IMPORT MODULE ============

model ImportLog {
  id              String   @id @default(cuid())
  importedById    String
  importedBy      User     @relation("UserImportLogs", fields: [importedById], references: [id])
  importType      String
  sourceContext   String?
  rawInput        String?  @db.Text
  totalRecords    Int      @default(0)
  newRecords      Int      @default(0)
  mergedRecords   Int      @default(0)
  skippedRecords  Int      @default(0)
  details         Json?
  status          String   @default("completed")
  createdAt       DateTime @default(now())
}

// ============================================
// INDIVIDUAL REVIEW MODULE - Updated 21.12.2025
// ============================================

model IndividualReview {
  id              String   @id @default(cuid())

  reviewerId      String
  reviewer        User     @relation("IndividualReviewReviewer", fields: [reviewerId], references: [id])
  contactId       String
  contact         Contact  @relation(fields: [contactId], references: [id])
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id])
  externalProjectName String?  // For projects not in system ("פרויקט חיצוני")
  
  accountability        Int
  accountabilityNote    String?  @db.Text
  boqQuality            Int
  boqQualityNote        String?  @db.Text
  specQuality           Int
  specQualityNote       String?  @db.Text
  planQuality           Int
  planQualityNote       String?  @db.Text
  valueEngineering      Int
  valueEngineeringNote  String?  @db.Text
  availability          Int
  availabilityNote      String?  @db.Text
  interpersonal         Int
  interpersonalNote     String?  @db.Text
  creativity            Int
  creativityNote        String?  @db.Text
  expertise             Int
  expertiseNote         String?  @db.Text
  timelinessAdherence   Int
  timelinessAdherenceNote String? @db.Text
  proactivity           Int
  proactivityNote       String?  @db.Text
  communication         Int
  communicationNote     String?  @db.Text
  
  generalNotes    String?  @db.Text
  avgRating       Float
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Note: When projectId is null, externalProjectName should be used
  // PostgreSQL treats NULL as distinct in unique constraints
  @@unique([reviewerId, contactId, projectId])
  @@index([reviewerId, contactId, externalProjectName])
}

// ============================================
// DUPLICATE MANAGEMENT MODULE - 14.01.2026
// ============================================

// כפילויות מזוהות לסקירה
model DuplicateSet {
  id            String    @id @default(cuid())
  entityType    String    // 'organization' | 'contact'
  primaryId     String    // הרשומה הראשית (מועמד ל-Master)
  secondaryId   String    // הרשומה המשנית (מועמד למיזוג)
  
  // ציון ונימוק מ-Gemini
  score         Float     // ציון דמיון (0-100)
  reason        String?   @db.Text  // נימוק מ-Gemini
  matchType     String    // 'exact_email' | 'exact_phone' | 'exact_business_id' | 'name_similarity' | 'gemini_detected'
  
  // סטטוס
  status        String    @default("pending") // 'pending' | 'approved' | 'rejected' | 'merged'
  
  // סקירה
  reviewedById  String?
  reviewedBy    User?     @relation("DuplicateSetReviewer", fields: [reviewedById], references: [id])
  reviewedAt    DateTime?
  reviewNotes   String?   @db.Text
  
  createdAt     DateTime  @default(now())
  
  @@unique([entityType, primaryId, secondaryId])
  @@index([entityType, status])
  @@index([status])
}

// היסטוריית מיזוגים (לשחזור)
model MergeHistory {
  id                String    @id @default(cuid())
  entityType        String    // 'organization' | 'contact'
  
  // מזהים
  survivorId        String    // הרשומה ששרדה (Master)
  mergedId          String    // הרשומה שנמחקה
  
  // Snapshots לשחזור
  mergedSnapshot    Json      // snapshot מלא של הרשומה שנמחקה
  relationsSnapshot Json      // snapshot של קשרים (reviews, projects, contacts)
  fieldResolutions  Json?     // איזה שדה נלקח מאיפה { phone: 'primary', email: 'secondary' }
  
  // מי ביצע
  mergedById        String
  mergedBy          User      @relation("MergeHistoryMerger", fields: [mergedById], references: [id])
  
  // Undo (אם בוצע)
  undoneAt          DateTime?
  undoneById        String?
  undoneBy          User?     @relation("MergeHistoryUndoer", fields: [undoneById], references: [id])
  
  createdAt         DateTime  @default(now())
  
  @@index([entityType, survivorId])
  @@index([entityType, mergedId])
}
